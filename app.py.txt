import streamlit as st
import pandas as pd
import google.generativeai as genai
from PIL import Image
import io

# Configura√ß√£o da IA
genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
model = genai.GenerativeModel('gemini-1.5-flash')

st.set_page_config(page_title="Extrator Dromos", layout="wide")
st.title("üèóÔ∏è Extrator de Fichas de Apropria√ß√£o - Dromos")

uploaded_files = st.file_uploader("Upload de PDFs ou Fotos das Fichas", type=['pdf', 'png', 'jpg'], accept_multiple_files=True)

if st.button("Processar Documentos"):
    if uploaded_files:
        resultados = []
        progress_bar = st.progress(0)
        
        for i, file in enumerate(uploaded_files):
            # Converte arquivo para imagem para a IA ler
            img = Image.open(file)
            
            prompt = """
            Analise esta Ficha de Apropria√ß√£o de Obra e extraia os dados para um formato JSON.
            Campos necess√°rios: DATA, FRENTE DE SERVI√áO, SENTIDO, ESTACA, MATERIAL, UNID, QUANT, SERVI√áO, ESTACA INICIAL, ESTACA FINAL, COMP, LARG, ALTURA, OBS.
            Aten√ß√£o: Os dados est√£o manuscritos. Extraia exatamente o que estiver escrito.
            Retorne APENAS o JSON.
            """
            
            response = model.generate_content([prompt, img])
            # Aqui adicionamos uma l√≥gica simples de tratamento do texto para o dicion√°rio
            # (Simplificado para o exemplo)
            try:
                dados = eval(response.text.replace("```json", "").replace("```", ""))
                resultados.append(dados)
            except:
                st.error(f"Erro ao ler o arquivo {file.name}")
            
            progress_bar.progress((i + 1) / len(uploaded_files))

        df = pd.DataFrame(resultados)
        st.write("### Dados Extra√≠dos", df)
        
        # Gerar Excel
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False)
        
        st.download_button(
            label="üì• Baixar Planilha Excel",
            data=output.getvalue(),
            file_name="apropriacao_dromos.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )